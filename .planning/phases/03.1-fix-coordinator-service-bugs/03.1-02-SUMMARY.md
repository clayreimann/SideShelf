---
phase: 03.1-fix-coordinator-service-bugs
plan: 02
subsystem: coordinator
tags: [state-machine, position-resolution, asyncstorage, media-progress]

# Dependency graph
requires:
  - phase: 03-position-reconciliation
    provides: resolveCanonicalPosition implementation; coordinator owns position
  - phase: 03.1-01
    provides: coordinator seek fixes; preSeekState context field

provides:
  - isFinished guard in resolveCanonicalPosition (activeSession branch)
  - isFinished guard in resolveCanonicalPosition (savedProgress branch)
  - AsyncStorage position cleared when finished item loads
  - currentTime reset to 0 in DB upsert when marking as unfinished
  - AsyncStorage position cleared when marking item as unfinished

affects:
  - 04-state-propagation (position resolution now handles isFinished; propagation must pass through 0 correctly)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "isFinished guard in resolveCanonicalPosition: check savedProgress.isFinished === true in BOTH the activeSession branch and the savedProgress branch — clear AsyncStorage and return 0 in both cases"
    - "Mark-as-unfinished reset: set currentTime=0, progress=0 in DB upsert AND clear AsyncStorage position — API call then sends currentTime=0 as well"

key-files:
  created: []
  modified:
    - src/services/coordinator/PlayerStateCoordinator.ts
    - src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts
    - src/components/library/LibraryItemDetail.tsx

key-decisions:
  - "isFinished guard placed BEFORE session position processing in the activeSession branch — finished items skip all session/timestamp comparison logic entirely"
  - "Both branches (activeSession and savedProgress) get isFinished guard — whichever branch runs, finished items return 0"
  - "AsyncStorage cleared in coordinator at read time (resolveCanonicalPosition) AND at write time (handleToggleFinished) — defense in depth"
  - "currentTime explicitly set to 0 (not preserved) when marking as unfinished — prevents API and DB divergence"

patterns-established:
  - "Position reset defense in depth: clear both DB (upsert with 0) and AsyncStorage on mark-as-unfinished; coordinator also clears AsyncStorage on read if isFinished is detected"

# Metrics
duration: 3min
completed: 2026-02-18
---

# Phase 03.1 Plan 02: Fix Finished-Item Position Bugs Summary

**isFinished guard in resolveCanonicalPosition returns position 0 for both session and savedProgress branches; mark-as-unfinished resets DB currentTime and AsyncStorage to 0**

## Performance

- **Duration:** ~3 min
- **Started:** 2026-02-18
- **Completed:** 2026-02-18
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- Fixed Bug 2 (CRITICAL): Playing a finished item now starts from position 0 — resolveCanonicalPosition checks isFinished in both the activeSession branch and the savedProgress branch
- Fixed Bug 2 (supporting): AsyncStorage position is cleared when coordinator detects a finished item, preventing stale end-of-book position from being reused
- Fixed Bug 3 (UX): Marking an item as unfinished now resets DB currentTime to 0 and progress to 0 — API call also sends currentTime 0
- Fixed Bug 3 (supporting): AsyncStorage position is cleared immediately after DB upsert when marking as unfinished
- Added 4 new coordinator tests covering all isFinished guard paths
- All 519 tests pass (0 regressions)

## Task Commits

Each task was committed atomically:

1. **Task 1: Guard resolveCanonicalPosition against finished items (Bug 2)** - `3a94ab8` (fix)
2. **Task 2: Reset position when marking item as unfinished (Bug 3)** - `611978e` (fix)

**Plan metadata:** (docs commit follows)

## Files Created/Modified

- `src/services/coordinator/PlayerStateCoordinator.ts` - Added isFinished guard in both activeSession and savedProgress branches of resolveCanonicalPosition; both guards clear AsyncStorage and return position 0
- `src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts` - New "BUG-02: finished items start from position 0" describe with 4 tests (no session, with session, AsyncStorage cleared, non-finished preserved)
- `src/components/library/LibraryItemDetail.tsx` - Import ASYNC_KEYS/saveItem; set currentTime=0 and progress=0 when marking as unfinished; clear AsyncStorage position after DB upsert when marking as unfinished

## Decisions Made

- isFinished guard placed BEFORE the session position processing in the activeSession branch — finished items skip all session/timestamp comparison logic entirely (simplest, clearest intent)
- Both branches (activeSession and savedProgress) get the isFinished guard so that whichever branch executes, finished items always return 0
- AsyncStorage cleared at read time (coordinator) AND at write time (UI component) — defense in depth ensures neither old session data nor cached position survives
- currentTime explicitly set to 0 (not `effectiveProgress.currentTime`) when marking as unfinished — prevents the UI from sending the stale end-of-book time to the API

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None. One note: the test assertion for AsyncStorage key uses `"position"` (the mock value) not `"abs.position"` (the real key) — this is correct because the test file mocks `ASYNC_KEYS` as `{ position: "position" }`.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Bug 2 and Bug 3 fixed; all 4 coordinator service bugs from the 03.1 research phase are now resolved (Bug 1 and Bug 4 in plan 01; Bug 2 and Bug 3 in plan 02)
- Phase 03.1 is complete — ready for Phase 4 (state propagation to subscribers)
- Phase 4 will need to propagate position correctly when resolveCanonicalPosition returns 0 for finished items

---

_Phase: 03.1-fix-coordinator-service-bugs_
_Completed: 2026-02-18_

## Self-Check: PASSED

- src/services/coordinator/PlayerStateCoordinator.ts: FOUND
- src/services/coordinator/**tests**/PlayerStateCoordinator.test.ts: FOUND
- src/components/library/LibraryItemDetail.tsx: FOUND
- .planning/phases/03.1-fix-coordinator-service-bugs/03.1-02-SUMMARY.md: FOUND
- Commit 3a94ab8: FOUND
- Commit 611978e: FOUND
