---
phase: 04-state-propagation
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts
  - src/services/__tests__/PlayerService.test.ts
autonomous: true

must_haves:
  truths:
    - "PROP-01 verified: grep confirms zero coordinator-owned store writes in all three service files (PlayerService, PlayerBackgroundService, ProgressService)"
    - "PROP-02 verified: usePlayerState selector already exists and is tested for selector-based subscription"
    - "PROP-03 verified: render count test confirms position-only components re-render on position change only"
    - "PROP-04 verified: sleep timer writes still function independently of coordinator bridge"
    - "PROP-05 verified: syncToStore gracefully handles BGS context where Zustand is unavailable"
    - "PROP-06 verified: updateNowPlayingMetadata fires on chapter change via bridge, periodic updates preserved in BGS"
  artifacts:
    - path: "src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts"
      provides: "PROP contract tests in coordinator test file"
      contains: "PROP-01"
    - path: "src/services/__tests__/PlayerService.test.ts"
      provides: "Updated PlayerService tests reflecting removed store writes"
      contains: "coordinator bridge"
  key_links:
    - from: "PROP-01 test"
      to: "grep output"
      via: "exec('grep') or manual assertion that no coordinator-owned writes exist in service files"
      pattern: "PROP-01"
    - from: "PROP-05 test"
      to: "syncToStore try/catch"
      via: "mocked getState throwing, coordinator survives"
      pattern: "PROP-05"
---

<objective>
Add contract tests verifying all six PROP requirements (PROP-01 through PROP-06). These tests prove the Phase 4 migration is correct and complete. Also update any existing PlayerService tests that assert direct store writes (which were removed in Plan 02).

Purpose: Contract tests are the acceptance criteria for Phase 4. They prove the bridge works, services don't bypass it, and documented exceptions are preserved.
Output: Comprehensive test coverage for all PROP requirements.
</objective>

<execution_context>
@/Users/clay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-state-propagation/04-RESEARCH.md
@.planning/phases/04-state-propagation/04-01-SUMMARY.md
@.planning/phases/04-state-propagation/04-02-SUMMARY.md
@src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts
@src/services/__tests__/PlayerService.test.ts
@src/services/coordinator/PlayerStateCoordinator.ts
@src/services/PlayerService.ts
@src/services/PlayerBackgroundService.ts
@src/services/ProgressService.ts
@src/stores/slices/playerSlice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PROP contract tests to coordinator test file</name>
  <files>src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts</files>
  <action>
Add a new `describe("PROP Contract Tests (Phase 4)")` block to the coordinator test file.

**PROP-01: "playerSlice receives all player state from coordinator"**

- This is partially a static analysis test. Add a test that runs through a full lifecycle (LOAD_TRACK -> PLAY -> NATIVE_PROGRESS_UPDATED -> PAUSE -> STOP) and verifies the store received the expected mutations at each step:
  - After LOAD_TRACK: `_setTrackLoading(true)` called via bridge
  - After PLAY: `updatePlayingState(true)` called via bridge
  - After NATIVE_PROGRESS_UPDATED: `updatePosition(X)` called via bridge
  - After PAUSE: `updatePlayingState(false)` called via bridge
  - After STOP: `_setCurrentTrack(null)` and `_setPlaySessionId(null)` called via bridge
- Also add a comment with the static verification grep that covers ALL THREE service files:
  `// Static verification: grep -rn "store\.\(updatePosition\|updatePlayingState\|_setTrackLoading\|_setCurrentTrack\|_setPlaySessionId\|_setSeeking\|_setPlaybackRate\|_setVolume\)" src/services/PlayerService.ts src/services/PlayerBackgroundService.ts src/services/ProgressService.ts — should only return documented exceptions`

**PROP-02: "usePlayerState selector-based subscriptions"**

- This is already implemented (usePlayerState exists in appStore.ts and passes selector through to useAppStore). Add an `it.skip` test with JSDoc explaining: "PROP-02 is structurally satisfied — usePlayerState(selector) passes through to Zustand's useAppStore(selector) which uses Object.is equality. No runtime test needed; the implementation is a one-liner."

**PROP-03: "Render counts do not increase after bridge"**

- Add a test that simulates 10 rapid position updates via the bridge and verifies that a component subscribing to `isPlaying` (not position) does not re-render. Use the React.Profiler pattern from research:
  - Create a minimal test component that uses `useAppStore(s => s.player.isPlaying)` and increments a render counter
  - Render it with `@testing-library/react-native`
  - Record baseline render count
  - Call `useAppStore.getState().updatePosition(X)` 10 times inside `act()`
  - Assert render count has NOT increased beyond baseline
- If the test infrastructure makes this impractical (mocked store, etc.), use `it.skip` with a JSDoc explanation and a manual verification command: "Run app, open React DevTools Profiler, play audio for 30s, verify FullScreenPlayer renders stay constant when only position changes."

**PROP-04: "Sleep timer retained as playerSlice-local"**

- Dispatch events that trigger syncStateToStore (PLAY, PAUSE, STOP)
- Before each dispatch, set a mock sleep timer value on the store: `store.player.sleepTimer = { endTime: 999, type: "duration", chapterTarget: null }`
- After bridge sync, verify `store.setSleepTimer` was never called by the bridge
- Verify `store.cancelSleepTimer` was never called by the bridge
- (The sleep timer value in store should remain as-is after bridge sync)

**PROP-05: "Android BGS does not call syncToStore"**

- Mock `useAppStore.getState` to throw (simulating headless JS context)
- Dispatch NATIVE_PROGRESS_UPDATED and PLAY events
- Assert coordinator processes them without error
- Assert no store mutations occurred
- Add JSDoc: "In production, Android BGS headless JS context makes useAppStore.getState() unavailable. The try/catch in syncToStore guards against this."

**PROP-06: "updateNowPlayingMetadata debounce preserved"**

- Dispatch CHAPTER_CHANGED with a chapter
- Assert `store.updateNowPlayingMetadata` was called once
- Dispatch NATIVE_PROGRESS_UPDATED (same chapter, no change)
- Assert `store.updateNowPlayingMetadata` was NOT called again from the bridge
- Dispatch another CHAPTER_CHANGED with a DIFFERENT chapter ID
- Assert `store.updateNowPlayingMetadata` was called again
- Add comment: "Periodic metadata updates (2s gate) are preserved in BGS handlePlaybackProgressUpdated — not tested here as that's BGS-specific, not bridge-specific"
  </action>
  <verify>
  Run: `npm test -- --testPathPattern="PlayerStateCoordinator" --verbose` — all tests pass including PROP contract tests.
  Run PROP-01 static verification across all three services: `grep -rn "store\.\(updatePosition\|updatePlayingState\|_setTrackLoading\|_setCurrentTrack\|_setPlaySessionId\|_setSeeking\|_setPlaybackRate\|_setVolume\)" src/services/PlayerService.ts src/services/PlayerBackgroundService.ts src/services/ProgressService.ts` — should only return documented exceptions.
  </verify>
  <done>
  PROP-01 through PROP-06 contract tests exist. PROP-01 verified via lifecycle test AND static grep covering all three service files (PlayerService, PlayerBackgroundService, ProgressService). PROP-02 documented as structurally satisfied. PROP-03 tested with render count pattern or documented with manual verification. PROP-04 verified sleep timer untouched by bridge. PROP-05 verified BGS graceful failure. PROP-06 verified chapter-change metadata firing.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Update existing PlayerService tests for removed store writes</name>
  <files>src/services/__tests__/PlayerService.test.ts</files>
  <action>
Read the existing PlayerService test file. Some tests may assert that PlayerService directly calls store mutators (e.g., `expect(store._setCurrentTrack).toHaveBeenCalled()` or `expect(store.updatePosition).toHaveBeenCalled()`). After Plan 02, those direct calls were removed — the coordinator bridge handles them instead.

For each test that asserts a removed store write:

1. If the test is asserting the removed write directly (e.g., "executeStop clears currentTrack"), update the assertion to verify that the coordinator will handle it — either by checking that the appropriate event was dispatched, or by removing the specific assertion and adding a comment: "// Store write removed in Phase 4 — coordinator bridge handles this via syncStateToStore()"
2. If the test is asserting a retained write (lastPauseTime, error-path \_setTrackLoading, \_setCurrentTrack for PlayerTrack building), keep the assertion as-is.

Also check for any tests that may have been broken by the RELOAD_QUEUE or NATIVE_PLAYBACK_ERROR changes to updateContextFromEvent (added in Plan 02's coordinator modifications). If those test files mock updateContextFromEvent behavior, they may need updating.

The goal is: all existing tests pass after the Plan 02 changes. If any test was already updated as part of Plan 02 execution, skip it here. Only fix tests that are still failing.

Run `npm test` first to identify which tests fail, then fix only the failing ones.
</action>
<verify>
Run: `npm test` — ALL tests across the entire test suite pass.
Run: `npm test -- --coverage --testPathPattern="PlayerService|PlayerStateCoordinator"` — verify coverage is maintained.
</verify>
<done>
All PlayerService tests pass after accounting for removed store writes. Test assertions updated to reflect coordinator bridge ownership. Full test suite passes with no regressions.
</done>
</task>

</tasks>

<verification>
1. `npm test` — full test suite passes with zero failures
2. `npm test -- --testPathPattern="PlayerStateCoordinator" --verbose` — PROP contract tests visible and passing
3. `npm test -- --coverage` — coverage maintained at or above pre-Phase-4 levels for modified files
4. Manual grep verification matches PROP-01 (all three service files):
   - `grep -rn "store\.\(updatePosition\|updatePlayingState\|_setTrackLoading\)" src/services/PlayerBackgroundService.ts` returns 0 results
   - `grep -rn "store\.\(updatePosition\|updatePlayingState\|_setTrackLoading\)" src/services/ProgressService.ts` returns 0 results (already clean, but verified)
   - `grep -rn "store\.\(_setCurrentTrack\|_setPlaySessionId\)" src/services/PlayerService.ts` returns only documented exceptions (executeLoadTrack PlayerTrack building, buildTrackList session ID, etc.)
</verification>

<success_criteria>

- PROP-01 through PROP-06 have corresponding tests (or documented skip with rationale for structural guarantees)
- PROP-01 static grep covers all three services: PlayerService, PlayerBackgroundService, ProgressService
- All existing tests pass without regression
- Full test suite green
- Coverage maintained
  </success_criteria>

<output>
After completion, create `.planning/phases/04-state-propagation/04-03-SUMMARY.md`
</output>
