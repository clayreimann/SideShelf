---
phase: 05-cleanup
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/coordinator/PlayerStateCoordinator.ts
  - src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts
autonomous: true
requirements:
  - CLEAN-02

must_haves:
  truths:
    - "observerMode field, isObserverMode(), and setObserverMode() are gone from PlayerStateCoordinator"
    - "Coordinator always executes transitions — no observer-mode guard branches exist"
    - "All 18 test references to observerMode/setObserverMode are removed or updated"
    - "npm test passes with no regressions"
  artifacts:
    - path: "src/services/coordinator/PlayerStateCoordinator.ts"
      provides: "Coordinator without observerMode scaffolding"
      contains: "Execution Mode"
    - path: "src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts"
      provides: "Updated coordinator tests with observer mode block deleted"
  key_links:
    - from: "PlayerStateCoordinator.ts handleEvent"
      to: "executeTransition"
      via: "always-execute (no observerMode guard)"
      pattern: "await this\\.executeTransition"
---

<objective>
Remove the observerMode flag and its scaffolding from PlayerStateCoordinator. The migration is production-proven — the kill-switch is no longer needed. This is the safest first deletion: no other code depends on observerMode being present.

Purpose: Eliminate migration scaffolding. The coordinator is always in execution mode after Phase 2 shipped.
Output: Cleaner coordinator with ~25 fewer lines; no observer-mode branches in handleEvent or sync methods.
</objective>

<execution_context>
@/Users/clay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/coordinator/PlayerStateCoordinator.ts
@src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete observerMode from PlayerStateCoordinator</name>
  <files>src/services/coordinator/PlayerStateCoordinator.ts</files>
  <action>
Remove all observerMode scaffolding from PlayerStateCoordinator.ts:

1. Delete the private field declaration (line 91): `private observerMode = false;`

2. Delete the `isObserverMode()` method (lines 185-187):

   ```
   isObserverMode(): boolean {
     return this.observerMode;
   }
   ```

3. Delete the `setObserverMode()` method (lines 194-197):

   ```
   setObserverMode(enabled: boolean): void {
     this.observerMode = enabled;
     log.info(...)
   }
   ```

4. In `handleEvent()` (around line 294), remove the `if (!this.observerMode)` wrapper that guards `executeTransition` + sync calls. The body always executes now. The result should be:

   ```typescript
   if (validation.allowed) {
     if (nextState && nextState !== currentState) {
       log.info(`[Coordinator] Transition: ${currentState} --[${event.type}]--> ${nextState}`);
       this.metrics.stateTransitionCount++;
       this.context.previousState = currentState;
       this.context.currentState = nextState;
     }
     await this.executeTransition(event, nextState);
     if (event.type === "NATIVE_PROGRESS_UPDATED") {
       this.syncPositionToStore();
     } else {
       this.syncStateToStore(event);
     }
   }
   ```

5. In `syncPositionToStore()` (line 720), remove the guard: `if (this.observerMode) return;`
   The method body should just be the try/catch directly.

6. In `syncStateToStore()` (line 749), remove the guard: `if (this.observerMode) return;`
   Same — body starts with the try block directly.

7. In `exportDiagnostics()`, remove `observerMode` from the returned object and from the return type annotation (if typed inline).

8. Update the constructor log message (line 106) — remove the ternary that referenced observerMode:
   Change: `[Coordinator] PlayerStateCoordinator initialized (${this.observerMode ? "Observer Mode" : "Execution Mode"})`
   To: `[Coordinator] PlayerStateCoordinator initialized (Execution Mode)`

9. Update the class-level JSDoc at the top of the file: remove Phase 1/Phase 2 observer mode narrative, the `observerMode=false` note, and the "KEY DESIGN DECISION" block about context updating "even in observer mode". Replace with a clean summary reflecting the current Phase 5 state.

10. Remove `if (this.observerMode)` comment in the `handleEvent` JSDoc if present.

Do NOT touch `executeTransition`, `syncPositionToStore` body, `syncStateToStore` body, or any other logic — only remove the guard lines and the three observerMode members.
</action>
<verify> - grep for `observerMode` in PlayerStateCoordinator.ts returns 0 results - grep for `isObserverMode\|setObserverMode` returns 0 results in the coordinator file - The file compiles (npx tsc --noEmit passes or check via npm test)
</verify>
<done>
PlayerStateCoordinator.ts contains no observerMode references. handleEvent always executes transitions. syncPositionToStore and syncStateToStore have no mode guard.
</done>
</task>

<task type="auto">
  <name>Task 2: Update coordinator tests to remove observer mode scaffolding</name>
  <files>src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts</files>
  <action>
There are 18 references to observerMode/setObserverMode in the test file. Handle each category:

**Category A — Delete the entire observer mode rollback block:**
Find and delete the `describe("observer mode rollback (EXEC-04)")` block (~60 lines). This block tests the kill-switch behavior that no longer exists. Delete the entire describe block and all tests within it.

**Category B — Tests that toggle observerMode for setup then test execution behavior:**
Find tests (particularly in `describe("EXEC-05 NATIVE_* context updates")` and `describe("PROP-05")`) that call `coordinator.setObserverMode(true)` as setup. For each:

- If the test is verifying that NATIVE\_\* events update context (which always happens), remove the `setObserverMode(true)` setup line. The test still passes because context always updates.
- If the test is verifying that execute* methods are NOT called in observer mode, convert it: verify that execute* methods ARE called (execution mode is now always on). Or delete the test if its only purpose was observer-mode-specific behavior.

**Category C — Tests that call `coordinator.isObserverMode()`:**
Remove assertions like `expect(coordinator.isObserverMode()).toBe(true)`. The method no longer exists.

**Specific guidance:**

- Read each affected describe block carefully before deleting. The EXEC-04 block is fully deletable.
- For EXEC-05 tests: the `setObserverMode(true)` lines were there to test that NATIVE events update context even in observer mode. After deletion, those tests simply run in execution mode — which is fine; context still updates from NATIVE events.
- For PROP-05 tests: these test the BGS headless guard (try/catch). They should not reference observerMode at all — remove mode-toggling lines if present.
- Do NOT delete tests that verify real execution behavior (e.g., "executePlay is called on PLAY event"). Only delete tests whose sole purpose is testing observer mode toggling.

After changes: `npm test -- --testPathPattern="PlayerStateCoordinator" --no-coverage` must pass with no failures.
</action>
<verify>npm test -- --testPathPattern="PlayerStateCoordinator" --no-coverage 2>&1 | tail -20</verify>
<done>
All coordinator tests pass. No setObserverMode or isObserverMode calls remain in the test file. The EXEC-04 observer mode rollback describe block is deleted.
</done>
</task>

</tasks>

<verification>
Run full test suite: `npm test -- --no-coverage 2>&1 | tail -30`

Check no observerMode remains:

- `grep -n "observerMode\|setObserverMode\|isObserverMode" src/services/coordinator/PlayerStateCoordinator.ts` → 0 results
- `grep -c "observerMode\|setObserverMode\|isObserverMode" src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts` → 0 results

Check coordinator still has sync methods:

- `grep -n "syncPositionToStore\|syncStateToStore" src/services/coordinator/PlayerStateCoordinator.ts` → finds both methods
  </verification>

<success_criteria>

- observerMode field and methods are deleted from PlayerStateCoordinator.ts
- handleEvent always executes transitions (no mode check)
- All coordinator tests pass with no new failures
- Full test suite passes
  </success_criteria>

<output>
After completion, create `.planning/phases/05-cleanup/05-01-SUMMARY.md`
</output>
