---
phase: 05-cleanup
plan: "06"
type: execute
wave: 5
depends_on:
  - "05-05"
files_modified:
  - src/services/ProgressService.ts
  - src/services/__tests__/ProgressService.test.ts
autonomous: true
requirements:
  - CLEAN-04

must_haves:
  truths:
    - "startSessionLocks Map is deleted from ProgressService"
    - "startSession no longer checks or updates startSessionLocks"
    - "The BGS existingSession guard (line 751 in BGS) remains — it is the effective duplicate-session guard"
    - "ProgressService.ts is approximately 20 lines shorter"
    - "All ProgressService tests pass"
    - "npm test passes with no regressions"
  artifacts:
    - path: "src/services/ProgressService.ts"
      provides: "ProgressService without startSessionLocks mutex"
  key_links:
    - from: "ProgressService.startSession"
      to: "BGS handleActiveTrackChanged existingSession guard"
      via: "coordinator serial queue prevents concurrent coordinator-originated calls; BGS guard prevents BGS-originated duplicates"
      pattern: "getCurrentSession"
---

<objective>
Remove the startSessionLocks mutex from ProgressService after the integration test (Plan 05) proves no duplicate sessions occur. The coordinator serial queue + BGS existingSession guard provide equivalent protection.

Purpose: Complete CLEAN-04. The mutex was added to handle races between coordinator and BGS paths — both now have structural guards that make it redundant.
Output: ProgressService.ts drops ~20 lines.
</objective>

<execution_context>
@/Users/clay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-cleanup/05-RESEARCH.md
@src/services/ProgressService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete startSessionLocks from ProgressService</name>
  <files>src/services/ProgressService.ts</files>
  <action>
Remove the startSessionLocks mutex from ProgressService.ts:

**1. Delete the field declaration (line 91):**

```typescript
private startSessionLocks = new Map<string, Promise<void>>();
```

Delete this line.

**2. Delete the mutex logic in startSession() (lines 232-258 approx):**
The current startSession contains a block like:

```typescript
// Check for existing lock for this library item
const existingLock = this.startSessionLocks.get(libraryItemId);
if (existingLock) {
  log.info(`[ProgressService] Waiting for existing startSession lock for ${libraryItemId}`);
  await existingLock;
  // If session was created while we waited, return it
  const session = await this.getCurrentSession(userId, libraryItemId);
  if (session) {
    log.info(`[ProgressService] Session created by concurrent call, returning existing session`);
    return session;
  }
}

// Create lock for this call
let resolveLock!: () => void;
const lockPromise = new Promise<void>((resolve) => {
  resolveLock = resolve;
});
this.startSessionLocks.set(libraryItemId, lockPromise);

try {
  // ... actual startSession logic ...
} finally {
  this.startSessionLocks.delete(libraryItemId);
  resolveLock();
}
```

Delete the entire mutex block (the existingLock check + lockPromise creation + startSessionLocks.set). Keep the `try { ... } finally { }` wrapper structure if it wraps real work — or remove it entirely and just have the session creation logic inline if the finally block only contained `delete` and `resolve`.

The session creation logic inside (DB lookups, API calls, session creation) is RETAINED. Only the mutex scaffolding around it is removed.

**3. Delete any other startSessionLocks references (lines 449-450 approx):**
Search for any remaining `.startSessionLocks` references and remove them.

**4. Verify the BGS guard is intact:**
Do NOT touch `src/services/PlayerBackgroundService.ts`. The check at line ~751 (`if (existingSession) return;` in `handleActiveTrackChanged`) is the replacement guard and must remain.

After deletions: `wc -l src/services/ProgressService.ts` should be ~20 lines shorter than before.
</action>
<verify> - `grep -n "startSessionLocks" src/services/ProgressService.ts` → 0 results - `wc -l src/services/ProgressService.ts` → fewer than before (target ~1,195 from baseline 1,215) - `grep -n "existingSession\|getCurrentSession" src/services/PlayerBackgroundService.ts` → BGS guard still exists
</verify>
<done>
startSessionLocks Map is fully removed from ProgressService. startSession no longer serializes via mutex. BGS existingSession guard remains intact.
</done>
</task>

<task type="auto">
  <name>Task 2: Update ProgressService tests and run full suite</name>
  <files>src/services/__tests__/ProgressService.test.ts</files>
  <action>
In the ProgressService test file, find and remove any tests that specifically test the startSessionLocks mutex behavior:

- Tests that verify concurrent calls are serialized via the lock
- Tests that verify the early return when a session is created by a concurrent call
- Tests that spy on `startSessionLocks` Map directly

These tests tested the mutex internals — since the mutex is deleted, these tests are dead. Delete them.

Retain all tests that verify:

- Normal single startSession call creates a session
- startSession returns existing session if one already exists (this tests actual business logic, not the mutex)
- Session lifecycle (create, update, end)
- getCurrentSession behavior

After test cleanup: `npm test -- --testPathPattern="ProgressService" --no-coverage 2>&1 | tail -20`

Then run the full suite: `npm test -- --no-coverage 2>&1 | tail -30`

Verify coverage for ProgressService is still ≥ 90%:

```bash
npm test -- --coverage --collectCoverageFrom="src/services/ProgressService.ts" 2>&1 | grep "ProgressService"
```

  </action>
  <verify>
    - `grep -n "startSessionLocks" src/services/__tests__/ProgressService.test.ts` → 0 results
    - `npm test -- --no-coverage 2>&1 | grep -E "PASS|FAIL|Tests:"` → all pass
  </verify>
  <done>
    ProgressService mutex tests deleted. All remaining ProgressService tests pass. Full test suite passes. Phase 5 cleanup is complete.
  </done>
</task>

</tasks>

<verification>
Final Phase 5 verification — run the full suite one last time:
```
npm test -- --no-coverage 2>&1 | tail -30
```

Verify all phase targets:

```bash
# CLEAN-01: startSessionLocks removed
grep -rn "startSessionLocks\|isRestoringState\|observerMode" src/services/ src/stores/

# CLEAN-02: PlayerService line count
wc -l src/services/PlayerService.ts

# CLEAN-03: BGS has no NowPlaying writes
grep -n "updateNowPlayingMetadata" src/services/PlayerBackgroundService.ts

# CLEAN-04: mutex removed
grep -n "startSessionLocks" src/services/ProgressService.ts
```

All → 0 results except PlayerService line count which must be &lt; 1,100.
</verification>

<success_criteria>

- startSessionLocks Map and all mutex logic removed from ProgressService
- BGS existingSession guard unchanged
- ProgressService tests updated (mutex-specific tests deleted)
- All tests pass
- Phase 5 complete: all 6 CLEAN requirements satisfied
  </success_criteria>

<output>
After completion, create `.planning/phases/05-cleanup/05-06-SUMMARY.md`
</output>
