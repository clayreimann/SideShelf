# External Integrations

**Analysis Date:** 2026-02-15

## APIs & External Services

**Audiobookshelf Server (Primary):**

- Service: Self-hosted Audiobookshelf media server
- Documentation: https://api.audiobookshelf.org/
- Client library: `src/lib/api/api.ts` and `src/lib/api/endpoints.ts`
- Authentication: Bearer token via Authorization header
- Endpoints:
  - Authentication: `/login` (POST for login, returns access/refresh tokens)
  - User info: `/api/me` (GET current user)
  - Libraries: `/api/libraries` (GET all user libraries)
  - Library items: `/api/libraries/{libraryId}/items` (GET paginated items with filters)
  - Item details: `/api/items/{itemId}` (GET full item with chapters, authors, series)
  - Media progress: `/api/me/progress/{libraryItemId}` (GET/PATCH user progress)
  - Playback sessions: `/api/session/local` (POST create), `/api/session/{sessionId}/sync` (POST sync), `/api/session/{sessionId}/close` (POST close)
  - Playback: `/api/items/{libraryItemId}/play` (POST start playback session with URLs)
  - Bookmarks: `/api/me/item/{libraryItemId}/bookmark` (POST create, DELETE remove)
  - Covers: `/api/items/{libraryItemId}/cover` (HEAD/GET image)
  - Author images: `/api/authors/{authorId}/image` (HEAD/GET image)
  - Batch operations: `/api/items/batch/get` (POST fetch multiple items)
  - Server health: `/ping` (GET health check, 5s timeout)
- Auth refresh: Automatic token refresh on 401 response (see `src/lib/api/api.ts` lines 66-72)

## Data Storage

**Databases:**

- **SQLite (Local):**
  - Provider: expo-sqlite (production), better-sqlite3 (dev/test)
  - Location: `abs2.sqlite` in app documents directory
  - ORM: Drizzle ORM 0.44.5
  - Schema: `src/db/schema/` with 17 table definitions
  - Key tables:
    - `users` - Local user account metadata
    - `libraries` - Downloaded library references
    - `libraryItems` - Media items (audiobooks, podcasts)
    - `audioFiles` - Individual audio files with download status
    - `chapters` - Chapter metadata for audiobooks
    - `mediaProgress` - User playback progress per item/episode
    - `localListeningSessions` - Playback session history
    - `bookmarks` - User-created bookmarks at specific times
    - `mediaMetadata`, `tags`, `genres`, `authors`, `narrators`, `series` - Metadata relations
  - Migrations: Auto-generated by drizzle-kit in `src/db/migrations/`
  - Access: All database writes through helpers in `src/db/helpers/` (required pattern)
  - Connection: Managed via Proxy pattern in `src/db/client.ts` for safe reset handling

**File Storage:**

- Local filesystem only
- Downloads directory: Device-specific path managed by `expo-file-system`
- Files excluded from iCloud backup via `setExcludeFromBackup()` (iOS optimization)
- Audio files: Referenced by path in database with download status tracking

**Caching:**

- Memory cache: In-service singletons (PlayerService, DownloadService, ProgressService)
- AsyncStorage cache: Playback state, user preferences (non-sensitive)
- SecureStore cache: API credentials (server URL, access token, refresh token, username)
- Logger cache: SQLite database for logs with automatic retention (1 hour default)

## Authentication & Identity

**Auth Provider:**

- Audiobookshelf self-hosted server (custom implementation)
- Login endpoint: `POST /login` with username/password
- Response: Access token (JWT) + refresh token

**Implementation:**

- Location: `src/services/ApiClientService.ts`
- Token storage:
  - Access token: `expo-secure-store` (key: `abs.accessToken`)
  - Refresh token: `expo-secure-store` (key: `abs.refreshToken`)
  - Server URL: `expo-secure-store` (key: `abs.serverUrl`)
  - Username: Dual storage in secure store + async storage (key: `abs.username`)
- Token refresh: Automatic on 401 response via `handleUnauthorized()` method
- Refresh mechanism: POST request to server (exact endpoint determined by server implementation)
- Listener pattern: Subscribers notified of auth state changes for UI synchronization
- Timeout: Configurable per-request (default 30 seconds)

**Login Flow:**

1. User provides baseUrl, username, password on login screen
2. Client sends POST to `{baseUrl}/login` with credentials
3. Server returns `{ user, accessToken, refreshToken }` (x-return-tokens header required)
4. Tokens stored in secure storage
5. API requests include `Authorization: Bearer {accessToken}`
6. On token expiry (401), automatic refresh via `handleUnauthorized()`

## Device & System Integration

**Device Information:**

- Library: `react-native-device-info` 14.1.1
- Data collected and sent to server:
  - OS name (iOS/Android)
  - OS version
  - Device name
  - Device type (phone/tablet)
  - Manufacturer (Android)
  - Model
  - API level (Android only)
  - Client name: "SideShelf"
  - Client version
  - Device ID
- Usage: Included in play session creation and user agent headers
- Cached: Device info queried once and cached in `src/lib/api/endpoints.ts` (lines 220-250)

**Network Status:**

- Library: @react-native-community/netinfo 11.4.1
- Used for: Download queue management, sync decision-making
- Access: Exported via network status store

**Device Capabilities:**

- Audio playback: Background audio mode enabled (iOS UIBackgroundModes config)
- Haptic feedback: expo-haptics for UI feedback
- Clipboard: expo-clipboard for share/copy operations
- System permissions: Handled via Expo's native modules

## Monitoring & Observability

**Error Tracking:**

- Not integrated - No Sentry, Datadog, Bugsnag, or Rollbar
- Approach: Local SQLite logging only

**Logs:**

- Library: react-native-logs 5.5.0 with custom SQLite transport
- Location: SQLite database (separate from app data)
- Retention: Configurable duration (default 1 hour minimum)
- Levels: debug, info, warn, error
- Disabled tags (by default): "api:fetch:detailed" (verbose API logging)
- Export: Accessible via `getAllLogs()` for remote troubleshooting
- Maintenance: Automatic purging every 100 logs or 5 minutes
- Database size: Queryable via `getDatabaseSize()`
- See `src/lib/logger/` for implementation

**Diagnostics:**

- Tag-based filtering available
- Per-tag log level configuration
- Error/warning count tracking

## CI/CD & Deployment

**Hosting:**

- iOS: App Store (via Apple App Store Connect)
- Android: Not explicitly configured (likely Google Play or internal)
- Over-the-air updates: expo-updates 29.0.12 (enabled, manual trigger via `checkAutomatically: "NEVER"`)

**CI Pipeline:**

- EAS Build (Expo Application Services)
- Configuration: `eas.json`
- Profiles:
  - **development**: Development client build (for rapid iteration)
  - **preview**: Internal distribution for testing
  - **production**: App Store submission with automatic version increment
- App version management: Remote source (AppStore, Play Store version)
- iOS submission: Automated to App Store Connect (ASC app ID: 6754254923)

**Build Process:**

- Prebuild: `expo prebuild --clean` generates native iOS/Android projects
- Run commands:
  - `npm run ios` - iOS simulator (with clean prebuild)
  - `npm run ios:device` - Physical iOS device (with clean prebuild)
  - `npm run android` - Android emulator
  - `npm start` - Development server
- TestFlight: Integrated via eas.json (preview profile for internal testing)

## Environment Configuration

**Required Environment Variables:**

- None in code (all configuration via UI at runtime or secure storage)
- Server configuration: Provided at app launch via login screen
  - Server URL (baseUrl)
  - Username
  - Password

**Secrets Location:**

- All sensitive data stored via expo-secure-store (Keychain on iOS, Keystore on Android)
- Never stored in environment files or .env
- Keys: `abs.serverUrl`, `abs.accessToken`, `abs.refreshToken`, `abs.username`

**Build Configuration:**

- `app.json`: Managed by git (contains published configuration, no secrets)
- `eas.json`: Managed by git (contains build profiles, no secrets)
- `.npmrc`: `legacy-peer-deps=true` for dependency compatibility

## Webhooks & Callbacks

**Incoming:**

- No incoming webhooks from external services
- Deep linking via expo-linking for app activation

**Outgoing:**

- Progress sync to server: PATCH `/api/me/progress/{libraryItemId}` (periodic + on-demand)
- Session sync to server: POST `/api/session/{sessionId}/sync` (periodic during playback)
- Bookmark creation: POST `/api/me/item/{libraryItemId}/bookmark` (user-initiated)
- Bookmark deletion: DELETE `/api/me/item/{libraryItemId}/bookmark/{bookmarkId}` (user-initiated)

## Background Services

**Background Audio:**

- Library: react-native-track-player 4.1.2
- iOS: Configured with UIBackgroundModes: ["audio"]
- Android: Automatic background service via TrackPlayer
- Services: `src/services/PlayerService.ts`, `src/services/PlayerBackgroundService.ts`

**Background Downloads:**

- Library: @kesha-antonov/react-native-background-downloader (custom fork)
- Continues downloads when app moves to background
- Service: `src/services/DownloadService.ts`
- Progress tracking: Event-based callbacks with throttled updates
- Auto-repair: Container path migration handling for iOS

**Background Sync:**

- Service: `src/services/ProgressService.ts`
- Periodic sync of media progress to server
- Session synchronization during playback
- Conflict resolution for offline scenarios

---

_Integration audit: 2026-02-15_
