---
phase: 03.1-fix-coordinator-service-bugs
plan: 01
subsystem: coordinator
tags: [state-machine, seeking, fsm, react-native-menu]

# Dependency graph
requires:
  - phase: 03-position-reconciliation
    provides: coordinator owns position resolution; PlayerStateCoordinator drives playback
  - phase: 02-execution-control
    provides: coordinator's executeTransition pattern; dispatchPlayerEvent from within executeTransition

provides:
  - preSeekState field on StateContext for seek-origin memory
  - Auto-PLAY dispatch from READY case when pre-seek state was PLAYING (Bug 1 fix)
  - isSeeking cleared by NATIVE_PROGRESS_UPDATED during SEEKING (not just SEEK_COMPLETE)
  - shouldOpenOnLongPress on MenuView in SkipButton (Bug 4 fix)

affects:
  - 03.1-02 (remaining coordinator bugs — seeks are now correctly handled)
  - 04-state-propagation (coordinator context now includes preSeekState field)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Pre-seek state capture: set preSeekState = currentState in updateContextFromEvent BEFORE transition; clear in executeTransition READY case after use"
    - "Seek resume: PLAYING->SEEKING->READY triggers dispatchPlayerEvent(PLAY) via coordinator's own executeTransition (not PlayerService)"
    - "shouldOpenOnLongPress: single prop on MenuView makes short press = action, long press = menu"

key-files:
  created: []
  modified:
    - src/types/coordinator.ts
    - src/services/coordinator/PlayerStateCoordinator.ts
    - src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts
    - src/components/player/SkipButton.tsx

key-decisions:
  - "preSeekState captured in updateContextFromEvent BEFORE transition executes — at that point currentState is still the pre-seek state (PLAYING/PAUSED)"
  - "Auto-PLAY dispatched via dispatchPlayerEvent in executeTransition READY case — mirrors the LOADING->PLAYING pattern from Phase 2"
  - "isSeeking cleared in NATIVE_PROGRESS_UPDATED handler (not only in SEEK_COMPLETE) — progress update is the real seek-completion signal from native"
  - "preSeekState cleared immediately after PLAY dispatch (not deferred) to prevent double-dispatch on any subsequent READY entry"

patterns-established:
  - "State-before-transition capture: updateContextFromEvent runs before currentState = nextState, so this.context.currentState still reflects origin state"

# Metrics
duration: 12min
completed: 2026-02-18
---

# Phase 03.1 Plan 01: Fix Coordinator Seek Bug + Skip Button Summary

**Coordinator seek-state recovery via preSeekState context field: PLAYING->SEEKING->READY auto-dispatches PLAY; SkipButton long-press menu via shouldOpenOnLongPress prop**

## Performance

- **Duration:** ~12 min
- **Started:** 2026-02-18
- **Completed:** 2026-02-18
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- Fixed Bug 1 (CRITICAL): Coordinator no longer gets stuck in READY after seek while playing — PLAYING->SEEKING->READY->PLAYING via auto-dispatched PLAY event
- Fixed Bug 1 (supporting): isSeeking is now cleared by NATIVE_PROGRESS_UPDATED during SEEKING (the real seek-completion signal), not only by SEEK_COMPLETE
- Fixed Bug 4 (UX): SkipButton short press now immediately skips; long press opens interval selection menu
- Added 4 new coordinator tests covering seek-while-playing, seek-while-paused, isSeeking clear, and preSeekState cleanup
- All 515 existing tests continue to pass (0 regressions)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix coordinator seek state memory loss (Bug 1)** - `fe314f4` (fix)
2. **Task 2: Fix skip button to use long press for menu (Bug 4)** - `1543ed9` (fix)

**Plan metadata:** (docs commit follows)

## Files Created/Modified

- `src/types/coordinator.ts` - Added `preSeekState: PlayerState | null` field to StateContext interface
- `src/services/coordinator/PlayerStateCoordinator.ts` - preSeekState capture in SEEK case, isSeeking clear in NATIVE_PROGRESS_UPDATED, auto-PLAY dispatch in READY case of executeTransition, preSeekState: null in createInitialContext
- `src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts` - New "seek state recovery (Bug 1)" describe with 4 tests
- `src/components/player/SkipButton.tsx` - Added `shouldOpenOnLongPress` prop to MenuView

## Decisions Made

- preSeekState captured in updateContextFromEvent BEFORE the transition executes — at that point currentState is still the origin state (PLAYING/PAUSED), which is correct
- Auto-PLAY dispatched via dispatchPlayerEvent in executeTransition READY case, not from within a PlayerService execute\* method, so existing EXEC-03 feedback loop tests are unaffected
- isSeeking cleared in NATIVE_PROGRESS_UPDATED handler because that is the actual seek-completion signal from native TrackPlayer (SEEK_COMPLETE is a logical event; progress update is the real one)
- preSeekState cleared immediately after PLAY dispatch in the READY case to prevent double-dispatch on any subsequent READY entry from a different path

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None. All transitions worked correctly on first run. The EXEC-03 feedback loop prevention tests remained passing because the auto-PLAY dispatch is triggered from coordinator's executeTransition (not from PlayerService execute\* methods), matching the LOADING->PLAYING pattern established in Phase 2.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Bug 1 and Bug 4 fixed; ready for 03.1-02 (remaining coordinator bugs: Bug 2 skip JUMP_FORWARD/JUMP_BACKWARD, Bug 3 diagnostics skip button)
- preSeekState field added to StateContext — Phase 4 subscriber propagation will need to handle the new field

---

_Phase: 03.1-fix-coordinator-service-bugs_
_Completed: 2026-02-18_

## Self-Check: PASSED

- src/types/coordinator.ts: FOUND
- src/services/coordinator/PlayerStateCoordinator.ts: FOUND
- src/services/coordinator/**tests**/PlayerStateCoordinator.test.ts: FOUND
- src/components/player/SkipButton.tsx: FOUND
- .planning/phases/03.1-fix-coordinator-service-bugs/03.1-01-SUMMARY.md: FOUND
- Commit fe314f4: FOUND
- Commit 1543ed9: FOUND
