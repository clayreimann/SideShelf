---
phase: 05-cleanup
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/PlayerService.ts
  - src/app/_layout.tsx
  - src/index.ts
autonomous: true
requirements:
  - CLEAN-02

must_haves:
  truths:
    - "reconcileTrackPlayerState, verifyTrackPlayerConsistency, syncStoreWithTrackPlayer are deleted from PlayerService"
    - "Dead accessor methods (getCurrentPlaySessionId, clearPlaySessionId, getCurrentTrack, getCurrentLibraryItemId) are deleted"
    - "ReconciliationReport interface is deleted"
    - "updateNowPlayingMetadata wrapper method is deleted from PlayerService"
    - "_layout.tsx and index.ts no longer call any of these deleted methods"
    - "PlayerService.ts line count is below 1,300 (significant reduction toward <1,100 target)"
    - "npm test passes with no regressions"
  artifacts:
    - path: "src/services/PlayerService.ts"
      provides: "PlayerService without reconciliation scaffolding or dead accessors"
    - path: "src/app/_layout.tsx"
      provides: "App layout without manual reconciliation calls"
    - path: "src/index.ts"
      provides: "App init without reconcileTrackPlayerState call"
  key_links:
    - from: "src/app/_layout.tsx"
      to: "playerService"
      via: "no reconcileTrackPlayerState, no verifyTrackPlayerConsistency, no syncStoreWithTrackPlayer calls"
      pattern: "reconcile|verifyTrackPlayer|syncStoreWith"
---

<objective>
Delete all pre-coordinator reconciliation scaffolding from PlayerService and remove the callers in _layout.tsx and index.ts. These methods were workarounds before the coordinator bridge existed. The bridge (Phase 4) makes them redundant.

Purpose: Achieve the bulk of the line count reduction for CLEAN-02. Targeted deletion with caller updates.
Output: PlayerService drops ~320 lines. \_layout.tsx and index.ts lose their manual reconciliation calls.
</objective>

<execution_context>
@/Users/clay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/services/PlayerService.ts
@src/app/_layout.tsx
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete dead methods and interface from PlayerService</name>
  <files>src/services/PlayerService.ts</files>
  <action>
Delete the following from PlayerService.ts in dependency order (delete callers before deletees where possible):

**1. `ReconciliationReport` interface (lines 51-58):**
Delete the entire interface block:

```typescript
interface ReconciliationReport {
  discrepanciesFound: boolean;
  actionsTaken: string[];
  trackMismatch: boolean;
  positionMismatch: boolean;
  rateMismatch: boolean;
  volumeMismatch: boolean;
}
```

**2. `reconcileTrackPlayerState()` method (lines 1039-1230, ~192 lines):**
Delete the entire method including its JSDoc comment. This is the largest deletion.

**3. `verifyTrackPlayerConsistency()` method (lines 981-1033, ~53 lines):**
Delete the entire method including its JSDoc comment.

**4. `syncStoreWithTrackPlayer()` method (lines 1297-1325, ~29 lines):**
Delete the entire method including its JSDoc comment.

**5. Dead accessor methods (~30 lines total):**
Delete all four:

- `getCurrentPlaySessionId()` (lines 842-845) — delegates to store, no external callers
- `clearPlaySessionId()` (lines 850-853) — delegates to store, no external callers
- `getCurrentTrack()` (lines 858-861) — only used by syncStoreWithTrackPlayer (being deleted)
- `getCurrentLibraryItemId()` (lines 866-870) — no external callers

Delete each method including its JSDoc comment.

**6. `updateNowPlayingMetadata()` wrapper method (lines 641-643, ~3 lines):**
Delete:

```typescript
async updateNowPlayingMetadata(): Promise<void> {
  await useAppStore.getState().updateNowPlayingMetadata();
}
```

And its JSDoc. Also remove the call to `this.updateNowPlayingMetadata()` in `executeLoadTrack()` (around line 388) — the coordinator's chapter detection (Plan 03) will handle this on the first progress tick.

For `refreshFilePathsAfterContainerChange()`: find any call to `this.updateNowPlayingMetadata()` in that method and replace with `await useAppStore.getState().updateNowPlayingMetadata()` (direct store call, since the wrapper is gone).

**After deletions:**

- Remove any now-unused imports that were only used by deleted methods (check: `TrackPlayer.getPlaybackState`, `State` from track-player may still be used elsewhere — verify before removing)
- Count final line count via `wc -l src/services/PlayerService.ts`
  </action>
  <verify> - `grep -n "reconcileTrackPlayerState\|verifyTrackPlayerConsistency\|syncStoreWithTrackPlayer\|ReconciliationReport" src/services/PlayerService.ts` → 0 results - `grep -n "getCurrentPlaySessionId\|clearPlaySessionId\|getCurrentTrack\|getCurrentLibraryItemId" src/services/PlayerService.ts` → 0 results (check these are method definitions, not store property accesses) - `grep -n "updateNowPlayingMetadata" src/services/PlayerService.ts` → 0 results - `wc -l src/services/PlayerService.ts` → should be under 1,300 lines (target path to &lt;1,100 with Plans 03-04)
  </verify>
  <done>
  All six deletion targets are removed from PlayerService.ts. No references to deleted method names remain in the file.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Update _layout.tsx and index.ts callers + run tests</name>
  <files>src/app/_layout.tsx, src/index.ts</files>
  <action>
Update the external callers that referenced the now-deleted PlayerService methods:

**src/app/\_layout.tsx — three call sites:**

1. **Line 115** — `await playerService.syncStoreWithTrackPlayer()` inside the "TrackPlayer is currently playing" branch:
   Remove this call and its surrounding try/catch block (lines ~113-120). The coordinator bridge already keeps the store in sync; no manual sync is needed. Also remove the `log.info("State synced from TrackPlayer successfully")` line. Keep the surrounding logic (checking `trackPlayerIsPlaying`, the comment about skipping restoration).

2. **Line 162** — `const isConsistent = await playerService.verifyTrackPlayerConsistency()`:
   Remove this line and the `log.info(\`Player service isConsistent=${isConsistent}\`)` line that follows (line 163). The coordinator bridge makes this check unnecessary.

3. **Line 166** — `await playerService.reconcileTrackPlayerState()`:
   Remove this line and its comment (line 165: `// Reconcile TrackPlayer state to ensure sync`).

After removals in `_layout.tsx`, verify the logic flow still makes sense: the `if (wasLongBackground || contextRecreated)` block should still call `restorePersistedState()` but no longer call verify or reconcile. The block can be simplified or the if-wrapper removed if its only remaining content is `restorePersistedState()`.

**src/index.ts — one call site:**

Line 112 — `await playerService.reconcileTrackPlayerState()`:
Remove this line and its comment (line 111: `// Reconcile TrackPlayer state with JS state`).

**After updates:**
Run: `npm test -- --no-coverage 2>&1 | tail -30`

If any tests in PlayerService.test.ts reference the deleted methods (getCurrentPlaySessionId, clearPlaySessionId, getCurrentTrack, getCurrentLibraryItemId, reconcileTrackPlayerState, verifyTrackPlayerConsistency, syncStoreWithTrackPlayer, updateNowPlayingMetadata), delete those test blocks.
</action>
<verify> - `grep -n "reconcileTrackPlayerState\|verifyTrackPlayerConsistency\|syncStoreWithTrackPlayer" src/app/_layout.tsx src/index.ts` → 0 results - `grep -n "getCurrentPlaySessionId\|clearPlaySessionId\|updateNowPlayingMetadata" src/app/_layout.tsx src/index.ts` → 0 results - `npm test -- --no-coverage 2>&1 | grep -E "PASS|FAIL|Tests:"` to confirm test results
</verify>
<done>
\_layout.tsx and index.ts no longer call any deleted PlayerService methods. All tests pass.
</done>
</task>

</tasks>

<verification>
Run full test suite: `npm test -- --no-coverage 2>&1 | tail -30`

Verify line count: `wc -l src/services/PlayerService.ts` (expect ~1,150-1,200 after this plan; Plans 03-04 will bring it to &lt;1,100)

Verify no deleted method names remain:

```
grep -rn "reconcileTrackPlayerState\|verifyTrackPlayerConsistency\|syncStoreWithTrackPlayer\|ReconciliationReport" src/
```

→ 0 results

Verify caller cleanup:

```
grep -n "reconcileTrackPlayerState\|verifyTrackPlayerConsistency\|syncStoreWithTrackPlayer" src/app/_layout.tsx src/index.ts
```

→ 0 results
</verification>

<success_criteria>

- ReconciliationReport interface deleted
- 5 methods deleted from PlayerService (reconcileTrackPlayerState, verifyTrackPlayerConsistency, syncStoreWithTrackPlayer, updateNowPlayingMetadata wrapper, 4 dead accessors)
- \_layout.tsx and index.ts callers updated (3 sites in \_layout.tsx, 1 in index.ts)
- All tests pass
- PlayerService.ts line count reduced by ~320 lines from 1,496 baseline
  </success_criteria>

<output>
After completion, create `.planning/phases/05-cleanup/05-02-SUMMARY.md`
</output>
