name: Publish PR Update

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  publish-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Export Expo update
        run: |
          # Export for iOS and Android
          npx expo export --platform ios --platform android --output-dir dist

          # Create metadata file for this update
          cat > dist/pr-metadata.json << EOF
          {
            "prNumber": ${{ github.event.pull_request.number }},
            "prTitle": "${{ github.event.pull_request.title }}",
            "commitSha": "${{ github.sha }}",
            "commitMessage": "$(git log -1 --pretty=%B | head -n 1)",
            "createdAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "branch": "${{ github.head_ref }}"
          }
          EOF

      - name: Upload update artifact
        uses: actions/upload-artifact@v4
        with:
          name: expo-update-pr-${{ github.event.pull_request.number }}
          path: dist/
          retention-days: 7  # Keep PR artifacts for 1 week

      - name: Deploy to GitHub Pages (optional)
        if: github.event.pull_request.head.repo.full_name == github.repository
        continue-on-error: true
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Clone gh-pages branch or create it
          git fetch origin gh-pages:gh-pages || git checkout --orphan gh-pages
          git checkout gh-pages

          # Create updates directory structure
          mkdir -p updates/pr-${{ github.event.pull_request.number }}

          # Copy exported update
          cp -r dist/* updates/pr-${{ github.event.pull_request.number }}/

          # Create index file for this PR
          cat > updates/pr-${{ github.event.pull_request.number }}/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>PR #${{ github.event.pull_request.number }} Update</title>
            <style>
              body { font-family: system-ui; max-width: 800px; margin: 40px auto; padding: 20px; }
              code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
              pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
            </style>
          </head>
          <body>
            <h1>Expo Update for PR #${{ github.event.pull_request.number }}</h1>
            <p><strong>Title:</strong> ${{ github.event.pull_request.title }}</p>
            <p><strong>Branch:</strong> ${{ github.head_ref }}</p>
            <p><strong>Commit:</strong> <code>${{ github.sha }}</code></p>

            <h2>Load in App</h2>
            <p>To load this update in your TestFlight build:</p>
            <ol>
              <li>Open SideShelf app</li>
              <li>Go to <strong>More â†’ Settings â†’ Bundle Loader</strong></li>
              <li>Enter the update URL:
                <pre>https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/updates/pr-${{ github.event.pull_request.number }}</pre>
              </li>
              <li>Tap "Check for Updates"</li>
              <li>Download and reload</li>
            </ol>

            <h2>Update Manifest</h2>
            <p>View the <a href="metadata.json">update manifest</a></p>
          </body>
          </html>
          EOF

          # Add and commit
          git add updates/
          git commit -m "Add update for PR #${{ github.event.pull_request.number }}" || echo "No changes to commit"

          # Push to gh-pages
          git push origin gh-pages

      - name: Comment on PR with update URL
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const prNumber = context.issue.number;
            const repo = context.repo;
            const runId = context.runId;

            // Construct GitHub Pages URL
            const pagesUrl = `https://${repo.owner}.github.io/${repo.repo}/updates/pr-${prNumber}`;

            const comment = `## ðŸ“¦ Expo Update Available

            A complete Expo OTA update for this PR is now available!

            ### Quick Load (GitHub Pages)

            If GitHub Pages is enabled, you can load this update directly:

            1. Open SideShelf â†’ **More â†’ Settings â†’ Bundle Loader**
            2. Enter update URL:
               \`\`\`
               ${pagesUrl}
               \`\`\`
            3. Tap **"Check for Updates"**
            4. Download and reload the app

            ### Manual Hosting

            Download the update artifact and host it yourself:

            1. **Download**: [expo-update-pr-${prNumber}](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
            2. **Extract** the artifact
            3. **Host** the files on any static web server (with CORS enabled)
            4. **Load** in app using your hosted URL

            ### What's Included

            - âœ… Full Expo update manifest
            - âœ… JavaScript bundles (iOS & Android)
            - âœ… Asset maps and metadata
            - âœ… Ready for expo-updates

            ### Requirements

            - App must have \`expo-updates\` enabled
            - Runtime version must match
            - Works in **preview** and **production** builds only

            ---

            ðŸ’¡ **Tip**: This is a proper Expo OTA update with manifest, not just a raw JS bundle. It works with expo-updates without requiring EAS!`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Expo Update Available')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
