---
phase: 03-position-reconciliation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/services/PlayerService.ts
  - src/services/PlayerBackgroundService.ts
  - src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts
autonomous: true

must_haves:
  truths:
    - "executeLoadTrack() calls coordinator.resolveCanonicalPosition() instead of this.determineResumePosition() and uses the returned position for the seek"
    - "reloadTrackPlayerQueue() calls coordinator.resolveCanonicalPosition() instead of this.determineResumePosition() and uses the returned position for the seek"
    - "determineResumePosition() method no longer exists in PlayerService (POS-04)"
    - "ResumePositionInfo and ResumeSource types no longer defined locally in PlayerService — imported from coordinator types"
    - "BGS handleActiveTrackChanged() uses the shared MIN_PLAUSIBLE_POSITION constant from types/coordinator.ts instead of a hardcoded local constant"
    - "Contract tests verify: position priority chain (POS-01), MIN_PLAUSIBLE_POSITION rejection (POS-02), native-0 guard during loading (POS-03)"
  artifacts:
    - path: "src/services/PlayerService.ts"
      provides: "executeLoadTrack and reloadTrackPlayerQueue wired to coordinator position reconciliation"
      contains: "resolveCanonicalPosition"
    - path: "src/services/PlayerBackgroundService.ts"
      provides: "Shared MIN_PLAUSIBLE_POSITION constant usage"
      contains: "import.*MIN_PLAUSIBLE_POSITION"
    - path: "src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts"
      provides: "POS-01 through POS-03 contract tests"
      contains: "POS-01|POS-02|POS-03"
  key_links:
    - from: "src/services/PlayerService.ts"
      to: "src/services/coordinator/PlayerStateCoordinator.ts"
      via: "getCoordinator().resolveCanonicalPosition(libraryItemId)"
      pattern: "resolveCanonicalPosition"
    - from: "src/services/PlayerBackgroundService.ts"
      to: "src/types/coordinator.ts"
      via: "import { MIN_PLAUSIBLE_POSITION }"
      pattern: "import.*MIN_PLAUSIBLE_POSITION.*coordinator"
---

<objective>
Wire both PlayerService callers to use the coordinator's resolveCanonicalPosition(), remove the old determineResumePosition() method, update BGS to use the shared constant, and add contract tests for POS-01 through POS-03.

Purpose: This completes the position reconciliation migration. After this plan, the coordinator is the single home for position resolution (POS-04), both code paths call it, and contract tests prove the requirements are satisfied.

Output: PlayerService with no determineResumePosition(); BGS with shared constant; contract tests for position reconciliation requirements.
</objective>

<execution_context>
@/Users/clay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/clay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-position-reconciliation/03-RESEARCH.md
@.planning/phases/03-position-reconciliation/03-01-SUMMARY.md
@src/services/PlayerService.ts
@src/services/PlayerBackgroundService.ts
@src/services/coordinator/PlayerStateCoordinator.ts
@src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire callers and remove determineResumePosition from PlayerService</name>
  <files>src/services/PlayerService.ts</files>
  <action>
Three changes to PlayerService.ts:

**Change A: Wire executeLoadTrack() to use coordinator (around line 365)**

Replace the current block:

```typescript
const resumeInfo = await this.determineResumePosition(libraryItemId);
if (
  resumeInfo.authoritativePosition !== null &&
  resumeInfo.asyncStoragePosition !== resumeInfo.authoritativePosition
) {
  await saveItem(ASYNC_KEYS.position, resumeInfo.authoritativePosition);
  log.info(
    `Synced AsyncStorage position to authoritative value: ${formatTime(resumeInfo.authoritativePosition)}s`
  );
}
```

With:

```typescript
const coordinator = getCoordinator();
const resumeInfo = await coordinator.resolveCanonicalPosition(libraryItemId);
```

The coordinator's resolveCanonicalPosition() already handles AsyncStorage syncing internally, so the saveItem block is no longer needed here.

Keep the existing seek logic that follows (lines 376-383 — `if (resumeInfo.position > 0) { ... seekTo ... }`) unchanged. It still uses `resumeInfo.position` which is returned by the coordinator method.

Import `getCoordinator` from `@/services/coordinator/PlayerStateCoordinator` if not already imported. (Check — it may already be imported via dispatchPlayerEvent path.)

**Change B: Wire reloadTrackPlayerQueue() to use coordinator (around line 585)**

Replace the current block:

```typescript
const resumeInfo = await this.determineResumePosition(track.libraryItemId);
if (
  resumeInfo.authoritativePosition !== null &&
  resumeInfo.asyncStoragePosition !== resumeInfo.authoritativePosition
) {
  await saveItem(ASYNC_KEYS.position, resumeInfo.authoritativePosition);
  log.info(
    `Synced AsyncStorage position to authoritative value: ${formatTime(resumeInfo.authoritativePosition)}s`
  );
}
```

With:

```typescript
const coordinator = getCoordinator();
const resumeInfo = await coordinator.resolveCanonicalPosition(track.libraryItemId);
```

Same rationale: coordinator handles AsyncStorage syncing. Keep the existing seek logic that follows unchanged.

**Change C: Remove determineResumePosition() method (lines 647-761)**

Delete the entire `private async determineResumePosition(libraryItemId: string): Promise<ResumePositionInfo>` method.

Also delete the local type definitions that are now exported from coordinator types:

- `type ResumeSource = "activeSession" | "savedProgress" | "asyncStorage" | "store";` (line 61)
- `interface ResumePositionInfo { ... }` (lines 63-68)

Import `ResumePositionInfo` from `@/types/coordinator` if any remaining code in PlayerService references it (check — the seek logic uses `resumeInfo.position` but doesn't reference the type explicitly, so the type import may not be needed).

Clean up any imports that are now unused after removing determineResumePosition():

- `getActiveSession` and `getAllActiveSessionsForUser` from `@/db/helpers/localListeningSessions` — check if used elsewhere in the file
- `getMediaProgressForLibraryItem` from `@/db/helpers/mediaProgress` — check if used elsewhere
- `getUserByUsername` from `@/db/helpers/users` — check if used elsewhere (it IS used in reconcileTrackPlayerState and other methods, so keep it)
- `getStoredUsername` from `@/lib/secureStore` — check if used elsewhere (it IS used elsewhere, so keep it)

Be careful: only remove imports that have ZERO remaining callers in the file. grep each import name across the file before removing.
</action>
<verify>
Run `npx tsc --noEmit` to confirm no type errors (this enforces POS-04 — if any code still calls determineResumePosition, compilation fails).
Run `npm test` to confirm no regression.
Verify removal: `grep -n "determineResumePosition" src/services/PlayerService.ts` should return zero results.
Verify wiring: `grep -n "resolveCanonicalPosition" src/services/PlayerService.ts` should show two call sites (executeLoadTrack and reloadTrackPlayerQueue).
</verify>
<done>Both executeLoadTrack() and reloadTrackPlayerQueue() call coordinator.resolveCanonicalPosition(). determineResumePosition() is deleted from PlayerService. Local ResumeSource/ResumePositionInfo types are deleted (now in coordinator types). All tests pass, TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 2: Update BGS to use shared MIN_PLAUSIBLE_POSITION constant</name>
  <files>src/services/PlayerBackgroundService.ts</files>
  <action>
In PlayerBackgroundService.ts, in handleActiveTrackChanged() (around line 744):

1. Remove the local `const MIN_PLAUSIBLE_POSITION = 5;` declaration.
2. Add import at top of file: `import { MIN_PLAUSIBLE_POSITION } from "@/types/coordinator";`
3. The rest of the code using MIN_PLAUSIBLE_POSITION in the method remains unchanged — it just now references the shared constant instead of a local one.

Verify there are no other hardcoded `= 5` position constants elsewhere in the file by searching for "plausible" or "= 5" in the file.

This is a small change but satisfies the requirement that the constant has exactly one definition (POS-02 foundation).
</action>
<verify>
Run `npx tsc --noEmit` to confirm no type errors.
Run `npm test` to confirm no regression.
Verify: `grep -n "MIN_PLAUSIBLE_POSITION" src/services/PlayerBackgroundService.ts` should show usage but NOT a local const declaration.
Verify: `grep -rn "MIN_PLAUSIBLE_POSITION" src/` should show exactly one definition (in types/coordinator.ts) and usages in coordinator and BGS.
</verify>
<done>BGS uses the shared MIN_PLAUSIBLE_POSITION constant from types/coordinator.ts. No local hardcoded constant remains. grep confirms one definition, multiple usages.</done>
</task>

<task type="auto">
  <name>Task 3: Add POS-01/02/03 contract tests and POS-06 documentation</name>
  <files>src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts</files>
  <action>
Add a new describe block `"Position Reconciliation (POS-01 through POS-03)"` to the coordinator test file. Tests should follow existing test patterns in the file (mock setup, coordinator.dispatch, state assertions, async queue drain with setTimeout).

**POS-01 tests — Position priority chain:**

The resolveCanonicalPosition method needs DB helpers and store mocked. Set up mocks for:

- `getStoredUsername` → returns "testuser"
- `getUserByUsername` → returns `{ id: "user1" }`
- `getActiveSession` → configurable per test
- `getMediaProgressForLibraryItem` → configurable per test
- `getAsyncItem(ASYNC_KEYS.position)` → configurable per test
- `useAppStore.getState().player.position` → configurable per test

Tests:

1. "should prefer active session position over saved progress" — mock activeSession with currentTime=1800 and savedProgress with currentTime=900, assert result.position === 1800 and result.source === "activeSession"
2. "should prefer saved progress when no active session exists" — mock activeSession=null, savedProgress.currentTime=900, assert result.position === 900 and result.source === "savedProgress"
3. "should fall back to AsyncStorage when no DB sources exist" — mock activeSession=null, savedProgress=null, asyncStoragePosition=600, assert result.position === 600 and result.source === "asyncStorage"
4. "should fall back to store position as last resort" — mock all DB/async sources as null, store.player.position=300, assert result.position === 300 and result.source === "store"
5. "should prefer more recent timestamp when large discrepancy exists" — mock activeSession with currentTime=100, updatedAt=old and savedProgress with currentTime=1800, lastUpdate=newer, assert result.position === 1800 (prefers newer)

**POS-02 tests — MIN_PLAUSIBLE_POSITION rejection:**

6. "should reject session position below MIN_PLAUSIBLE_POSITION when saved progress is available" — mock activeSession.currentTime=3, savedProgress.currentTime=1800, assert result.position === 1800 and result.source === "savedProgress"
7. "should reject session position below MIN_PLAUSIBLE_POSITION and fall back to AsyncStorage" — mock activeSession.currentTime=2, savedProgress=null, asyncStoragePosition=600, assert result.position === 600
8. "should accept session position below MIN_PLAUSIBLE_POSITION when no better alternative" — mock activeSession.currentTime=3, savedProgress=null, asyncStoragePosition=null, assert result.position === 3 (no better option)

**POS-03 tests — Native-0 guard during loading:**

These test the updateContextFromEvent behavior directly via dispatching events:

9. "should not overwrite context.position with native 0 during loading" — dispatch LOAD_TRACK (enters LOADING), then set coordinator context position to 1800 manually or via a prior event, then dispatch NATIVE_PROGRESS_UPDATED with position=0 and duration=3600, assert coordinator.getContext().position !== 0 (still 1800). Assert duration IS updated to 3600.
10. "should accept native position > 0 during loading" — dispatch LOAD_TRACK, then NATIVE_PROGRESS_UPDATED with position=500, assert context.position === 500
11. "should accept native position 0 when NOT loading" — with coordinator in PLAYING state, dispatch NATIVE_PROGRESS_UPDATED with position=0, assert context.position === 0

**POS-06 documentation:**

Add a test (or a describe block comment) documenting POS-06: 12. Add a describe block comment: "POS-06: Android BGS coordinator isolation is satisfied by convention — BGS creates its own coordinator instance via getCoordinator(), both coordinators read from DB, neither writes to the other's in-memory state. See PlayerBackgroundService.ts lines 44-52."

No executable test needed for POS-06 — it's a convention, not a testable behavior. A skipped test or comment is sufficient.

**Note on testing resolveCanonicalPosition:** Since it's a public method on the coordinator, tests can call `coordinator.resolveCanonicalPosition("lib-item-1")` directly after setting up mocks. The method is async and returns ResumePositionInfo. Mock the DB helpers at module level using jest.mock().
</action>
<verify>
Run `npm test -- --testPathPattern="coordinator"` to confirm all new and existing tests pass.
Run `npm test` for full suite.
Count new tests: `grep -c "should\|it(" src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts` should show increase from baseline.
Verify POS coverage: `grep -n "POS-0[1-3]" src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts` should show test descriptions referencing POS requirements.
</verify>
<done>11+ new contract tests covering POS-01 (priority chain, 5 tests), POS-02 (MIN_PLAUSIBLE_POSITION rejection, 3 tests), POS-03 (native-0 guard, 3 tests), and POS-06 documentation. All tests pass. Full test suite green.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm test` passes (full suite, no regression)
- `grep -rn "determineResumePosition" src/services/` returns ZERO results (POS-04 complete)
- `grep -rn "MIN_PLAUSIBLE_POSITION" src/` shows exactly ONE definition in types/coordinator.ts
- `grep -n "resolveCanonicalPosition" src/services/PlayerService.ts` shows TWO call sites
- `grep -n "POS-0[1-3]" src/services/coordinator/__tests__/PlayerStateCoordinator.test.ts` shows contract test coverage
- Position reconciliation has exactly one home: the coordinator
</verification>

<success_criteria>

- determineResumePosition() deleted from PlayerService (POS-04)
- Both callers (executeLoadTrack + reloadTrackPlayerQueue) wired to coordinator
- BGS uses shared constant (no more inline duplicates)
- Contract tests prove POS-01 through POS-03
- POS-06 documented as convention-satisfied
- All tests pass, zero type errors
  </success_criteria>

<output>
After completion, create `.planning/phases/03-position-reconciliation/03-02-SUMMARY.md`
</output>
